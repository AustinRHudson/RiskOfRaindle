<!DOCTYPE HTMl>
<html>
    <style>
        body{
            background-size: 100%;
        }
        .guessing-field{
            margin:auto;
            width: 0%;
            text-align: center;
        }
        .header{
            margin: 10px;
            background-size:auto;
            vertical-align: middle;
            width: 100px;
            height: 30px;
            display: inline-block;
            text-align: center;
            line-height:normal;
        }
        .item-guesses{
            display: flex;
            flex-direction: column;
            min-height: 100px;
            margin: auto;
            margin-top: 5%;
            max-width: fit-content;
        }
        .item-guess{
            background-color: rgb(109, 152, 233);
            min-width: 600px;
            min-height: 20px;
        }
        .item-quality{
            margin: 10px;
            background-color: red;
            background-size:auto;
            vertical-align: middle;
            width: 100px;
            height: 100px;
            display: inline-block;
            text-align: center;
            line-height:normal;
        }
        .win-text-holder{
            text-align: center;
        }

    </style>
    <head>
        <meta charset="utf-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script type="text/javascript" src="Book.json"></script>
    </head>
    <body background="backgroundImage.jpg">
        <div id="result-table"></div>
        <pre id="result"></pre>
        <div class="guessing-field">
            <input id="textField" type="text" list="item" placeholder="Item name">
            <datalist id="item"></datalist>
        </div>
        <div class="item-guesses">
            <div class="item-guess">
                <div class="header">Name</div>
                <div class="header">Rarity</div>
                <div class="header">Chest Type</div>
                <div class="header">Game Origin</div>
                <div class="header">Stacking Type</div>
                <div class="header">Unlock Type</div>
                <div class="header">Modifers</div>
            </div>
        </div>
        <div class="win-text-holder" style="display: none;">
            You won!
        </div>
        <script type="module">
            var itemList
            loadItems()
            
            function loadItems(){
            fetch('Book.json')
            .then(response => response.json())
            .then(data => {itemList = data;}).then(() => {
                makeItemArray(itemList)
            })
            .catch(error => loadItems());
            }
            
        </script>
        

        <script>
            var won = false
            var raindleAnswer
            var raindleAnswerArray
            var matches
            var totalMatches
            var modifierText
            var modifierAmount
            var answerModifierAmount
            var itemArray = []
            var nameIndex = 0
            var rarityIndex = 1
            var chestType = 2
            var gameOrigin = 3
            var stackingType = 4
            var unlockType = 5
            var modifierType = 6

            
            function makeItemArray(itemList){
                for(var i = 0; i < itemList.length; i++){
                    itemArray[i] = []
                    itemArray[i][nameIndex] = itemList[i]["Name"]
                    itemArray[i][rarityIndex] = itemList[i]["Rarity"]
                    itemArray[i][chestType] = itemList[i]["Chest Type"]
                    itemArray[i][gameOrigin] = itemList[i]["Game Origin"]
                    itemArray[i][stackingType] = itemList[i]["Stacking Type"]
                    itemArray[i][unlockType] = itemList[i]["Unlock Type"]
                    itemArray[i][modifierType] = itemList[i]["Modifier Type"]
                }
                fillArray(itemArray);
            }

            function fillArray(){
                var itemTextField = document.getElementById("item")
                var option
                for(var i = 0; i<itemArray.length; i++){
                    option = document.createElement("option")
                    option.value = itemArray[i][nameIndex]
                    itemTextField.appendChild(option)
                }
                randomItemGenerator()
            }
            var answerArray
            var itemGuess
            var itemGuesses = document.getElementsByClassName("item-guesses")
            var winTextHolder = document.getElementsByClassName("win-text-holder")
            var guessedItems = []
            var inputField = document.getElementById("textField")
            $("#textField").on('keyup', function (event) {
            if (event.keyCode === 13) {
                 checkAnswer(inputField.value);
                }
             });

             function randomItemGenerator(){
                var rng = Math.floor(Math.random() * itemArray.length) + 1
                raindleAnswer = itemArray[rng][nameIndex]
                raindleAnswerArray = itemArray[rng]
                console.log(raindleAnswerArray)
             }

             function incorrectQuality(text){
                    var itemQuality = document.createElement("div")
                    itemQuality.className = "item-quality"
                    itemQuality.style.backgroundColor = "red"
                    var itemText = document.createElement("span")
                    itemText.className = "item-text"
                    itemText.innerHTML = text
                    itemQuality.appendChild(itemText)
                    itemGuess.appendChild(itemQuality)
                }

             function correctQuality(text){
                    var itemQuality = document.createElement("div")
                    itemQuality.className = "item-quality"
                    itemQuality.style.backgroundColor = "green"
                    var itemText = document.createElement("span")
                    itemText.className = "item-text"
                    itemText.innerHTML = text
                    itemQuality.appendChild(itemText)
                    itemGuess.appendChild(itemQuality)
                }

            function slightQuality(text){
                var itemQuality = document.createElement("div")
                    itemQuality.className = "item-quality"
                    itemQuality.style.backgroundColor = "yellow"
                    var itemText = document.createElement("span")
                    itemText.className = "item-text"
                    itemText.innerHTML = text
                    itemQuality.appendChild(itemText)
                    itemGuess.appendChild(itemQuality)
            }

            function checkAnswer(answer){
                    console.log(won)
                    if(getItemArray(answer) && !(won)){
                if(guessedItems.indexOf(answer) < 0){
                    guessedItems.push(answer)
                    inputField.value = ""
                    itemGuess = document.createElement("div")
                    itemGuess.className = "item-guess"
                    
                    if(itemGuesses.childNodes){
                        console.log(itemGuesses.childNodes[0])
                        itemGuesses.insertBefore(itemGuess, itemGuesses.childNodes[0])
                    }else{
                        itemGuesses[0].appendChild(itemGuess)
                    }
                    
                    var itemName = document.createElement("div")
                    itemName.className = "item-quality"
                    itemName.style.backgroundColor = "gray"
                    var itemText = document.createElement("span")
                    itemText.className = "item-text"
                    itemText.innerHTML = answer
                    itemName.appendChild(itemText)
                    itemGuess.appendChild(itemName)
                if(raindleAnswer == answer){
                    won = true
                    getItemArray(answer)
                    correctQuality(answerArray[rarityIndex])
                    correctQuality(answerArray[chestType])
                    correctQuality(answerArray[gameOrigin])
                    correctQuality(answerArray[stackingType])
                    correctQuality(answerArray[unlockType])
                    correctQuality(answerArray[modifierType])
                    winTextHolder[0].style.display = "block"
                }else{

                    getItemArray(answer)
                    removeOption(answer)
                    compareAnswer()
                }
            }
                    }
            }

            function removeOption(answer){
                var option = document.getElementById("item")
                var optionElement = option.getElementsByTagName('OPTION');
                for(var i = 0; i < optionElement.length; i++){
                    console.log(optionElement[i].value, answer)
                    if(optionElement[i].value == answer){
                        optionElement[i].remove()
                        break
                    }
                }
                inputField.value = ""
            }

            function getItemArray(answer){
                for(var i = 0; i < itemArray.length; i++){
                    if(itemArray[i][nameIndex] == answer){
                        answerArray = itemArray[i]
                        return true
                        break
                    }
                }
                return false
            }

            function compareQuality(compareType){
               console.log(answerArray, answerArray[modifierType])
               var answerModifiers = answerArray[compareType].split(", ")
               var raindleModifiers = raindleAnswerArray[compareType].split(", ")
               matches = 0
               totalMatches = raindleModifiers.length
               modifierAmount = answerModifiers.length
               answerModifierAmount = raindleModifiers.length
               var i
               var x
                for(i = 0; i < answerModifiers.length; i++){
                    for(x = 0; x < raindleModifiers.length; x++){
                        if(answerModifiers[i] == raindleModifiers[x]){
                            matches += 1
                            raindleModifiers.splice(x, 1)
                            break
                        }
                    }
                }

                console.log(matches + "/" + totalMatches)
            }

            function compareAnswer(){
                if(answerArray[rarityIndex] == raindleAnswerArray[rarityIndex]){
                    correctQuality(answerArray[rarityIndex])
                }else{
                    incorrectQuality(answerArray[rarityIndex])
                }

                compareQuality(chestType)
                if(matches == totalMatches && !(modifierAmount > answerModifierAmount)){
                    correctQuality(answerArray[chestType])
                }
                else if(matches == 0){
                    incorrectQuality(answerArray[chestType])
                }else{
                    slightQuality(answerArray[chestType])
                }

                if(answerArray[gameOrigin] == raindleAnswerArray[gameOrigin]){
                    correctQuality(answerArray[gameOrigin])
                }else{
                    incorrectQuality(answerArray[gameOrigin])
                }
                compareQuality(stackingType)
                if(matches == totalMatches && !(modifierAmount > answerModifierAmount)){
                    correctQuality(answerArray[stackingType])
                }
                else if(matches == 0){
                    incorrectQuality(answerArray[stackingType])
                }else{
                    slightQuality(answerArray[stackingType])
                }

                if(answerArray[unlockType] == raindleAnswerArray[unlockType]){
                    correctQuality(answerArray[unlockType])
                }else{
                    incorrectQuality(answerArray[unlockType])
                }
                compareQuality(modifierType)
                if(matches == totalMatches && !(modifierAmount > answerModifierAmount)){
                    correctQuality(answerArray[modifierType])
                }else if(matches == 0){
                    incorrectQuality(answerArray[modifierType])
                }else{
                    slightQuality(answerArray[modifierType])
                }
                
            }
        </script>
    </body>
</html>